<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="arkusz.css">
    <title>Eater</title>
</head>

<body>
    <script>
        // onkeydown="down(event)" onkeyup="up(event)"
        let tab_item = []
        let tab_server = []
        let tab_players = []
        let tab_created_players = []
        let playerID = null
        let playerColor = "#00000000"
        const ws = new WebSocket('ws://192.168.43.201:3000');
        ws.onopen = () => {
            ws.send('reciver');
        }
        ws.onmessage = (e) => {
            let decoded = JSON.parse(e.data)
            if (decoded.status == "init") {
                if (decoded.id == null) {
                    setTimeout(() => {
                        ws.send('reciver');
                    }, 500);
                } else {
                    playerID = decoded.id
                    playerColor = decoded.players[decoded.id].color
                    tab_players = decoded.players
                    game()
                }
            } else if (decoded.status == "data") {
                tab_server = decoded.obstacles
                tab_players = decoded.players
                if (tab_players[playerID] == null) {
                    ws.close()
                    location.reload(true);
                }

            }

        }

        ws.onerror = (e) => {
            console.log("/---error---\\")
            console.log(e.message);
            console.log("\\---error---/")
        };

        ws.onclose = (e) => {
            console.log("/---koniec---\\")
            console.log(e.code, e.reason);
            console.log("\\---koniec---/")
        };

        function game() {

            let render_h = 800
            let render_w = 800

            let h = 4000
            let w = 4000

            let render_left = h / 2
            let render_top = w / 2

            let cPlayer = tab_players[playerID]
            let size = (cPlayer.size ? cPlayer.size : 50)
            let ph = (cPlayer.ph ? cPlayer.ph : h / 2 - 50 / 2)
            let pw = (cPlayer.pw ? cPlayer.pw : w / 2 - 50 / 2)
            let field = field_out(size)

            let render = document.createElement("div")
            render.id = "render"
            render.style.width = render_h + "px"
            render.style.height = render_w + "px"

            let main = document.createElement("div")
            main.id = "main"
            main.style.width = w + "px"
            main.style.height = h + "px"
            main.addEventListener("click", leftClick)

            let tabela = document.createElement("div")
            tabela.id = "tabela"
            tabela.style.width = 200 + "px"
            tabela.style.height = 200 + "px"
            tabela.style.left = (render_w + 20) + "px"

            let ItemSizeX = document.createElement("input")
            ItemSizeX.id = "ItemSizeX"
            ItemSizeX.className = "tabela_item"
            ItemSizeX.value = 30
            ItemSizeX.style.width = tabela.style.width

            let ItemSizeY = document.createElement("input")
            ItemSizeY.id = "ItemSizeY"
            ItemSizeY.className = "tabela_item"
            ItemSizeY.value = 50
            ItemSizeY.style.width = tabela.style.width

            let squere = document.createElement("input")
            squere.id = "squere"
            squere.className = "tabela_item"
            squere.type = "radio"
            squere.name = "shape"
            squere.defaultChecked = "true"
            squere.style.width = tabela.style.width

            tabela.append(ItemSizeX, ItemSizeY, squere)

            let player = document.createElement("div")
            player.id = "player"
            player.style.width = size + "px"
            player.style.height = size + "px"
            // player.style.borderRadius = size + "px"
            player.style.top = ph + "px"
            player.style.left = pw + "px"
            player.style.backgroundColor = playerColor

            main.append(player)
            render.append(main)
            document.body.append(render, tabela)

            function leftClick(e) {
                let temp1 = document.getElementById("ItemSizeX")
                let temp2 = document.getElementById("ItemSizeY")
                if (temp1.value > 0 && isNaN(temp1.value) == false && temp2.value > 0 && isNaN(temp2.value) == false) {
                    let sh = 0
                    let item_sizeX = temp1.value
                    let item_sizeY = temp2.value
                    let parent = document.getElementById("main")
                    let x = e.clientX - parent.offsetLeft
                    let y = e.clientY - parent.offsetTop
                    x = x - item_sizeX / 2
                    y = y - item_sizeY / 2

                    send(x + "|" + y + "|" + item_sizeX + "," + item_sizeY + "|" + sh)
                }
            }

            function generate(element) {
                let x = parseInt(element.split("|")[0])
                let y = parseInt(element.split("|")[1])
                let item_sizeX = parseInt(element.split("|")[2].split(",")[0])
                let item_sizeY = parseInt(element.split("|")[2].split(",")[1])
                let sh = parseInt(element.split("|")[3])
                let item = document.createElement("div")
                item.style.backgroundColor = "black"

                item.style.width = item_sizeX + "px"
                item.style.height = item_sizeY + "px"
                item.style.left = x + "px"
                item.style.top = y + "px"
                item.className = "item"

                item.id = x + "|" + y + "|" + item_sizeX + "," + item_sizeY + "|" + sh
                main.append(item)

                tab_item.push(x + "|" + y + "|" + item_sizeX + "," + item_sizeY + "|" + sh)
            }


            function send(element) {
                ws.send(JSON.stringify({ status: "add", obstacle: element }))
            }

            let r, l, u, d = false

            function down(e) {
                if (e.which == 39 || e.which == 68) {
                    r = true
                }
                if (e.which == 38 || e.which == 87) {
                    u = true
                }
                if (e.which == 37 || e.which == 65) {
                    l = true
                }
                if (e.which == 40 || e.which == 83) {
                    d = true
                }
            }
            function up(e) {
                if (e.which == 39 || e.which == 68) {
                    r = false
                }
                if (e.which == 38 || e.which == 87) {
                    u = false
                }
                if (e.which == 37 || e.which == 65) {
                    l = false
                }
                if (e.which == 40 || e.which == 83) {
                    d = false
                }
            }

            let speedH = 0
            let speedW = 0
            let maxspeed = 120
            let tarcie = 0.3
            let speedUpH = 0
            let speedUpW = 0
            let ph_p = render_h / 2 - size / 2
            let pw_p = render_w / 2 - size / 2

            setInterval(() => {
                if (tab_players && tab_players[playerID] && tab_players[playerID].y != undefined && tab_players[playerID].x != undefined) {
                    speedUpH = parseFloat(tab_players[playerID].y) * 2
                    speedUpW = parseFloat(tab_players[playerID].x) * 2
                }

                if (Math.abs(speedW) < maxspeed) {
                    speedW -= speedUpW
                }
                if (Math.abs(speedH) < maxspeed) {
                    speedH += speedUpH
                }
                if (speedH < 0) {
                    speedH += tarcie
                } else {
                    speedH -= tarcie
                }
                if (speedW < 0) {
                    speedW += tarcie
                } else {
                    speedW -= tarcie
                }

                if (ph + speedH / 10 > h - size) {
                    ph = h - size
                    speedH = 0
                }
                if (ph + speedH / 10 < 0) {
                    ph = 0
                    speedH = 0
                }
                if (pw + speedW / 10 > w - size) {
                    pw = w - size
                    speedW = 0
                }
                if (pw + speedW / 10 < 0) {
                    pw = 0
                    speedW = 0
                }

                ph_p = ph
                pw_p = pw
                ph += Math.round(speedH / 10)
                pw += Math.round(speedW / 10)
                colide(ph, pw)

                player.style.top = ph + "px"
                player.style.left = pw + "px"

                render_top = -ph + (render_h / 2) - (size / 2)
                render_left = -pw + (render_w / 2) - (size / 2)

                if (render_left >= 0 || render_left + w < render_w) {
                } else {
                    main.style.left = render_left + "px"
                }
                if (render_top >= 0 || render_top + h < render_h) {
                } else {
                    main.style.top = render_top + "px"
                }
                for (let i = 0; i < tab_server.length; i++) {
                    if (!tab_item.includes(tab_server[i])) {
                        generate(tab_server[i])
                    }
                }
                for (let i = 0; i < tab_item.length; i++) {
                    if (!tab_server.includes(tab_item[i])) {
                        temp = document.getElementById(tab_item[i])
                        main.removeChild(temp)
                        tab_item.splice(tab_item.indexOf(tab_item[i]), 1)
                    }
                }
                for (let i = 0; i < tab_players.length; i++) {
                    console.log(playerID)
                    if (tab_players[i] && tab_players[i] != null && tab_players[i].id != playerID) {
                        let sPlayer = tab_players[i]
                        if (!tab_created_players.includes(sPlayer.id)) {
                            if (sPlayer.active) {
                                tab_created_players.push(sPlayer.id)
                                let user = document.createElement("div")
                                user.id = "player" + sPlayer.id
                                user.className = "item"
                                user.style.width = (sPlayer.size ? sPlayer.size : 50) + "px"
                                user.style.height = (sPlayer.size ? sPlayer.size : 50) + "px"
                                user.style.top = (sPlayer.ph ? sPlayer.ph : h / 2 - 50 / 2) + "px"
                                user.style.left = (sPlayer.pw ? sPlayer.pw : w / 2 - 50 / 2) + "px"
                                user.style.backgroundColor = (sPlayer.color ? sPlayer.color : "white")
                                main.append(user)
                            }
                        } else {
                            console.log(sPlayer.id)
                            if (sPlayer.active) {
                                let user = document.getElementById("player" + sPlayer.id)
                                user.style.opacity = 100 + "%"
                                user.style.width = (sPlayer.size ? sPlayer.size : 50) + "px"
                                user.style.height = (sPlayer.size ? sPlayer.size : 50) + "px"
                                user.style.top = (sPlayer.ph ? sPlayer.ph : h / 2 - 50 / 2) + "px"
                                user.style.left = (sPlayer.pw ? sPlayer.pw : w / 2 - 50 / 2) + "px"
                                user.style.backgroundColor = (sPlayer.color ? sPlayer.color : "white")
                            } else {
                                let user = document.getElementById("player" + sPlayer.id)
                                user.style.opacity = 0 + "%"
                                // main.removeChild(user)
                                // tab_created_players.splice(tab_created_players.indexOf(sPlayer.id), 1)
                            }
                        }
                    }
                }
                for (let i = 0; i < tab_created_players.length; i++) {
                    if (tab_players[tab_created_players[i]] == null || tab_created_players[i] == playerID) {
                        tab_created_players.splice(i, 1)
                    }
                }
                ws.send(JSON.stringify({ status: "up", size: size, ph: ph, pw: pw }))
            }, 10);

            function colide(hei, wid) {
                for (let i = 0; i < tab_item.length; i++) {
                    let x = parseInt(tab_item[i].split("|")[0])
                    let y = parseInt(tab_item[i].split("|")[1])
                    let sx = parseInt(tab_item[i].split("|")[2].split(",")[0])
                    let sy = parseInt(tab_item[i].split("|")[2].split(",")[1])
                    let sh = parseInt(tab_item[i].split("|")[3])
                    let test = document.getElementById(tab_item[i])

                    if (x > w) {
                        x = 0
                    }

                }
                for (let i = 0; i < tab_item.length; i++) {
                    let x = parseInt(tab_item[i].split("|")[0])
                    let y = parseInt(tab_item[i].split("|")[1])
                    let sx = parseInt(tab_item[i].split("|")[2].split(",")[0])
                    let sy = parseInt(tab_item[i].split("|")[2].split(",")[1])
                    let sh = parseInt(tab_item[i].split("|")[3])

                    if (sh == 0) {

                        if (colide_rect(wid, hei, x, y, sx, sy) && (sx * sy) < field) {
                            field += ((sx / 2) * (sx / 2) * 3.14) / 50
                            size = field_in(field)
                            player.style.width = size + "px"
                            player.style.height = size + "px"
                            ws.send(JSON.stringify({ status: "remove", obstacle: tab_item[i] }))
                        } else {
                            let check_test = 0

                            if (colide_rect(wid, ph_p, x, y, sx, sy) && (sx * sy) > field) {
                                while (colide_rect(wid, ph_p, x, y, sx, sy) && check_test < 100) {
                                    if (wid + size / 2 > x + sx / 2) {
                                        wid++
                                    } else {
                                        wid--
                                    }
                                    check_test++
                                }
                                check_test = 0
                                speedW = 0
                                pw = wid
                            }

                            if (colide_rect(pw_p, hei, x, y, sx, sy) && (sx * sy) > field) {
                                while (colide_rect(pw_p, hei, x, y, sx, sy) && check_test < 100) {
                                    if (hei + size / 2 > y + sy / 2) {
                                        hei++
                                    } else {
                                        hei--
                                    }
                                    check_test++
                                }
                                check_test = 0
                                speedH = 0
                                ph = hei
                            }
                        }
                    }
                }
            }

            function colide_rect(wid, hei, x, y, sx, sy) {
                if (wid > x - size && wid < x + sx && hei > y - size && hei < y + sy) {
                    return true
                } else {
                    return false
                }
            }

            function field_in(a) {
                a = a / 3.14
                a = Math.sqrt(a)
                a = a * 2
                a = Math.round(a)
                return a
            }

            function field_out(a) {
                a = a / 2
                a = a * a
                a = a * 3.14
                a = Math.round(a)
                return a
            }

        }
    </script>
</body>

</html>